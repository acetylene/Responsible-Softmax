\usepackage{amsmath, amsthm, amssymb, amsfonts, mathtools, mathrsfs, bm, bbm}

\usepackage[square, sort, comma, numbers]{natbib}
\usepackage{ifthen}
\usepackage{relsize}
\usepackage{graphicx}  % Required for including images
\usepackage{booktabs} % Top and bottom rules for tables
%\usepackage{caption}
\usepackage{subcaption}
\usepackage{textcomp}
\usepackage{physics}
\usepackage{array}
\usepackage{tikz}
\usetikzlibrary{automata, positioning}
\tikzset{every state/.style={minimum size=0pt}}

\usepackage[toc]{appendix}
\usepackage{fancyvrb}
\usepackage{listings}

%Settings for the listings package. Setup is currently for MATLAB defaults
\lstset{% general command to set parameter(s)
	basicstyle=\tiny, % print whole listing small
	keywordstyle=\color{blue}\bfseries,
	% underlined bold black keywords
	identifierstyle=, % nothing happens
	commentstyle=\color{green}, % white comments
	stringstyle=\color{purple}\ttfamily, % typewriter type for strings
	showstringspaces=false}

\usepackage{placeins}
\usepackage{float}
\usepackage{hyperref}

%\usepackage[lofdepth,lotdepth]{subfig}
% Packages to have pseudocode must be included after hyperref!!!

\usepackage{setspace}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{chngcntr}


\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}

\def \ga{\alpha} \def \gb{\beta}  \def \gd{\delta} \def \gw{\omega} \def \gW{\Omega}
\def \gt{\theta} \def \gp{\phi} \def \ge{\epsilon} \def \gs{\sigma}
\def \gl{\lambda} \def \gz{\zeta} \def \gr{\rho} \def \GT{\Theta}

%\def \gg{\gamma}

\def \BF{\mathbb{F}}
\def \<{\langle} \def \>{\rangle}
\newcommand{\overbar}[1]{\mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu}

\newcommand{\oo}{\infty}

\newcommand{\fr}[1]{\mathfrak{#1}}
\renewcommand{\op}[1]{\operatorname{#1}}
\newcommand{\Unit}[1]{{#1}^{\times}}
\newcommand{\cc}[1]{\overline{#1}}
\newcommand{\KX}[1]{\ifthenelse{\equal{#1}{1}}{$K[x]$}{$K[x_1,x_2,\ldots,x_{#1}]$}}

\newcommand{\Ryan}[1]{\ifdraft\textcolor{red}{Ryan says: #1}\fi}
\newcommand{\Marek}[1]{\ifdraft\textcolor{blue}{Marek says: #1}\fi}
\newcommand{\Dave}[1]{\ifdraft\textcolor{plum}{Dave says: #1}\fi}
\newcommand{\Clay}[1]{\ifdraft\textcolor{green}{Clay says: #1}\fi}
\newcommand{\Rob}[1]{\ifdraft\textcolor{orange}{Robert says: #1}\fi}

\newcommand{\R}{\mathbb R}
\newcommand{\HHH}{\mathbb H}
\newcommand{\RR}{\mathcal R}
\newcommand{\SSS}{\mathcal S}
\newcommand{\SSSS}{\mathfrak S}
\newcommand{\CC}{\textrm{C}}
\newcommand{\charr}{\textrm{char}}
\newcommand{\Supp}{\textrm{Supp}}
\newcommand{\CM}{\mathcal M}
\newcommand{\HH}{\textrm{H}}
\newcommand{\htt}{\textrm{ht}}
\newcommand{\Imm}{\textrm{Im}}
\newcommand{\ds}{\displaystyle}

\newcommand{\agmax}{\textrm{argmax}}
\DeclareRobustCommand{\pder1}[2]{\frac{\partial {#1}}{\partial {#2}}}

\newcommand{\N}{\mathbb N}
\newcommand{\ac}{\mathfrak{a}}
\newcommand{\mc}{\mathfrak{m}}
\newcommand{\Pc}{\mathfrak{P}}
\newcommand{\pc}{\mathfrak{p}}

%\newcommand{\MM}{\textrm{M}}
\newcommand{\PG}{\textrm{P}\Gamma_1}
\newcommand{\BA}{\mathbb{A}}
\newcommand{\QQ}{\mathbb Q}
\newcommand{\ZZ}{\mathbb Z}
\newcommand{\KK}{\mathbb K}
\newcommand{\BC}{\mathbb C}
\newcommand{\Prj}{\mathbb P}
\newcommand{\ri}{\mathcal{O}}
\newcommand{\FS}{\mathfrak F}
\newcommand{\Norm}{\textrm{N}}
\newcommand{\End}{\textrm{End}}
\newcommand{\Cl}{\textrm{Cl}}
\newcommand{\Qbar}{\overline{\Q}}

\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Frob}{Frob}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\PGL}{PGL}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Stab}{Stab}
\DeclareMathOperator{\Fix}{Fix}
\DeclareMathOperator{\Inn}{Inn}
\DeclareMathOperator{\Bil}{Bil}
\DeclareMathOperator{\disc}{Disc}


\DeclareFontFamily{U}{wncy}{}
\DeclareFontShape{U}{wncy}{m}{n}{<->wncyr10}{}
\DeclareSymbolFont{mcy}{U}{wncy}{m}{n}
\DeclareMathSymbol{\Sh}{\mathord}{mcy}{"58} 

\theoremstyle{definition}
\newtheorem{defn}{Definition}[chapter]%[section]
\newtheorem{thm}{Theorem}[chapter]

\theoremstyle{remark}
\newtheorem{rk}[defn]{Remark}
\newtheorem{ex}{Exercise}
\newtheorem{eg}[defn]{Example}
\newtheorem*{soln}{Solution}
\newtheorem{experiment}[defn]{Experiment}
\newtheorem{calc}[defn]{Calculation}

\theoremstyle{plain}
\newtheorem{lemm}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}

%\numberwithin{defn}{section}

\newcommand{\Matrix}[1]{\begin{bmatrix} #1 \end{bmatrix}}
 \newcommand{\Vector}[1]{\begin{pmatrix} #1 \end{pmatrix}}

% \newcommand*{\norm}[1]{\mathopen\| #1 \mathclose\|}% use instead of $\|x\|$
% \newcommand*{\abs}[1]{\mathopen| #1 \mathclose|}% use instead of $\|x\|$
 \newcommand*{\normLR}[1]{\left\| #1 \right\|}% use instead of $\|x\|$

 \newcommand*{\SET}[1]  {\ensuremath{\mathcal{#1}}}
 \newcommand*{\FUN}[1]  {\ensuremath{\mathcal{#1}}}
 \newcommand*{\MAT}[1]  {\ensuremath{\boldsymbol{#1}}}
 \newcommand*{\VEC}[1]  {\ensuremath{\boldsymbol{#1}}}
 \newcommand*{\CONST}[1]{\ensuremath{\mathit{#1}}}
 
% \newcommand{\bra}{\langle}
% \newcommand{\ket}{\rangle}
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 % commands for quick dissertation writing
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 \newcommand*{\Rpi}[2][\bm\pi]{ \(R_{#2}({#1})\)} 
 \newcommand*{\elpi}[2][\bm\pi]{\ell_{#2}({#1})}
 \newcommand*{\RS}{responsible softmax }
 \newcommand*{\DR}{dynamic responsibility }
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 \DeclareMathOperator*{\argmax}{arg\,max}
 \DeclareMathOperator*{\diag}{diag}
 \DeclareMathOperator*{\argmin}{arg\,min}
 \DeclareMathOperator*{\vectorize}{vec}
 \DeclareMathOperator*{\reshape}{reshape}

 %-----------------------------------------------------------------------------
 % Differentiation
 \newcommand*{\Nabla}[1]{\nabla_{\!#1}}

 \renewcommand*{\d}{\mathrm{d}}
% \newcommand*{\dd}{\partial}

 \newcommand*{\At}[2]{\ensuremath{\left.#1\right|_{#2}}}
 \newcommand*{\AtZero}[1]{\At{#1}{\pp=\VEC 0}}

 \newcommand*{\diffp}[2]{\ensuremath{\frac{\dd #1}{\dd #2}}}
 \newcommand*{\diffpp}[3]{\ensuremath{\frac{\dd^2 #1}{\dd #2 \dd #3}}}
 \newcommand*{\diffppp}[4]{\ensuremath{\frac{\dd^3 #1}{\dd #2 \dd #3 \dd #4}}}
 \newcommand*{\difff}[2]{\ensuremath{\frac{\d #1}{\d #2}}}
 \newcommand*{\diffff}[3]{\ensuremath{\frac{\d^2 #1}{\d #2 \d #3}}}
 \newcommand*{\difffp}[3]{\ensuremath{\frac{\dd\d #1}{\d #2 \dd #3}}}
 \newcommand*{\difffpp}[4]{\ensuremath{\frac{\dd^2\d #1}{\d #2 \dd #3 \dd #4}}}

 \newcommand*{\diffpAtZero}[2]{\ensuremath{\AtZero{\diffp{#1}{#2}}}}
 \newcommand*{\diffppAtZero}[3]{\ensuremath{\AtZero{\diffpp{#1}{#2}{#3}}}}
 \newcommand*{\difffAt}[3]{\ensuremath{\At{\difff{#1}{#2}}{#3}}}
 \newcommand*{\difffAtZero}[2]{\ensuremath{\AtZero{\difff{#1}{#2}}}}
 \newcommand*{\difffpAtZero}[3]{\ensuremath{\AtZero{\difffp{#1}{#2}{#3}}}}
 \newcommand*{\difffppAtZero}[4]{\ensuremath{\AtZero{\difffpp{#1}{#2}{#3}{#4}}}}

 %-----------------------------------------------------------------------------
 % Defined
 % How should the defined operator look like (:= or ^= ==)
 % (I want back my :=, it is so much better than ^= because (1) it has a
 % direction and (2) everyone here uses it.)
 %
 % Use :=
 \newcommand*{\defined}{\ensuremath{\mathrel{\mathop{:}}=}}
 \newcommand*{\definedRight}{\ensuremath{=\mathrel{\mathop{:}}}}
 % Use ^=
 %\newcommand*{\defined}{\ensuremath{\triangleq}}
 %\newcommand*{\definedRight}{\ensuremath{\triangleq}}
 % Use = with three bars
 %\newcommand*{\defined}{\ensuremath{?}}
 %\newcommand*{\definedRight}{\ensuremath{?}}

%-----------------------------------------------------------------------------
 % Domains
 \newcommand*{\D}{\mathcal{D}}
 \newcommand*{\I}{\mathcal{I}}

 %-----------------------------------------------------------------------------
 % Texture coordinates
 \newcommand*{\rr}{\VEC{r}}

 %-----------------------------------------------------------------------------
 % Parameters
 \newcommand*{\pt}{\VEC{\tau}}
 \newcommand*{\pr}{\VEC{\rho}}
 \newcommand*{\pp}{\VEC{p}}
% \newcommand*{\qq}{\VEC{q}}
 \newcommand*{\xx}{\VEC{x}}
 \newcommand*{\deltaq}{\Delta \qq}
 \newcommand*{\deltap}{\Delta \pp}
 \newcommand*{\zz}{\VEC{z}}
 \newcommand*{\pa}{\VEC{\alpha}}
 \newcommand*{\qa}{\VEC{\alpha}}
% \newcommand*{\pb}{\VEC{\beta}}

 %-----------------------------------------------------------------------------
 % Optimal appearance parameters
 \newcommand*{\pbh}[1]{\ensuremath{\hat{\pb}({#1})}}

 %-----------------------------------------------------------------------------
 % Warp basis
 \newcommand*{\M}[1]{\ensuremath{M({#1})}}
 \newcommand*{\LL}[1]{\ensuremath{L({#1})}}

 %-----------------------------------------------------------------------------
 % Matrices of the texture model
 \newcommand*{\AM}[1]{\ensuremath{\Lambda(#1)}}               % Lambda(beta) 
 \newcommand*{\AMr}[2]{\ensuremath{\Lambda(#1; #2)}}        % Lambda(r, beta)

 \newcommand*{\As}{A}         % Continuous Basis symbol
 \newcommand*{\afs}{a}        % Continuous mean symbol
 \newcommand*{\Ab}[1]{\As(#1)}         % Continuous Basis
 \newcommand*{\af}[1]{\afs(#1)}        % Continuous mean


 %-----------------------------------------------------------------------------
 % Matrices of the shape model
 \newcommand*{\MU}{\VEC{\mu}}
 \newcommand*{\MM}{\MAT{M}}

 %-----------------------------------------------------------------------------
 %% The project out matrix and operator
 \newcommand*{\INT}{\MAT{P}}
 \newcommand*{\INTf}{P}

 %-----------------------------------------------------------------------------
 % The identity matrix
 \newcommand*{\EYEtwo}{\Matrix{1 & 0\\0&1}}
 \newcommand*{\EYE}{\MAT E}
 \newcommand*{\EYEf}{E}

 % Wether to use subscripts or brackets for some function arguments
 % can be decided by commenting out the corresponding functions underneath
 %-----------------------------------------------------------------------------
 % Mapping
 \newcommand*{\Cs}[1]{\ensuremath{C^{#1}}} % C symbol
 \newcommand*{\C}[2]{\ensuremath{C^{#1}(#2)}} % Use C with brackets

 %-----------------------------------------------------------------------------
 % Objective function
 \newcommand*{\Fs}{\ensuremath{F}}              % F symbol
 \newcommand*{\F}[1]{\ensuremath{\Fs(#1)}}       % Use F with brackets    F(q)

 %-----------------------------------------------------------------------------
 % Approximated objective functions
 \newcommand*{\FFs}{\tilde{F}}                     % ~F symbol
 \newcommand*{\FF}[1]{\ensuremath{\FFs(#1)}}       % Use ~F with brackets    F(q)

 %-----------------------------------------------------------------------------
 % residual function
 \newcommand*{\es}{\ensuremath{f}}              % R symbol

 \newcommand*{\e}[1]{\ensuremath{\es(#1)}}         % R(q)
 \newcommand*{\er}[2]{\ensuremath{\es(#1; #2)}}    % R(r; q)

 %-----------------------------------------------------------------------------
 % Approximated residual functions
 \newcommand*{\ees}{\tilde{f}}                       % ~R symbol
 \newcommand*{\ee}[1]{\ensuremath{\ees(#1)}}       % ~R(q)
 \newcommand*{\eer}[2]{\ensuremath{\ees(#2; #1)}}  % ~R(r; q)

 %-----------------------------------------------------------------------------
 % Warps
 \newcommand*{\Vs}{\ensuremath{V}}
 \newcommand*{\VLins}{\ensuremath{\Vs^{\text{Ortho}}}}
 \newcommand{\VModels}{\ensuremath{\Vs^{\text{Model}}}}
 \newcommand*{\Ws}{\ensuremath{W}}

 \newcommand{\V}[1]{\ensuremath{\Vs(#1)}}
 \newcommand{\VModel}[1]{\ensuremath{\VModels(#1)}}
 \newcommand{\Vr}[2]{\ensuremath{\Vs(#1; #2)}}
 \newcommand{\VInvr}[2]{\ensuremath{\Vs^{-1}(#1; #2)}}
 \newcommand{\VrLin}[2]{\ensuremath{\VLins(#1; #2)}}
 \newcommand{\W}[1]{\ensuremath{\Ws(#1)}}
 \newcommand{\Winv}[1]{\ensuremath{\Ws^{-1}(#1)}}
 \newcommand{\Wr}[2]{\ensuremath{\Ws(#1; #2)}}
 \renewcommand{\arraystretch}{0.65}
 
%-----------------------------------------------------------

% set equation numbering to include section and subsection numbers
\numberwithin{equation}{chapter}

\makeatletter
\let\OldStatex\Statex
\renewcommand{\Statex}[1][3]{%
  \setlength\@tempdima{\algorithmicindent}%
  \OldStatex\hskip\dimexpr#1\@tempdima\relax}
\makeatother